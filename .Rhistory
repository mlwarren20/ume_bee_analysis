names(all_contaminants) <- plate_ids
for (id in plate_ids) {
neg_controls <- sample_metadata %>%
filter(grepl(id, sample) & origin == "NC" & sample %in% rownames(asv_counts))
contaminants <- names(which(colSums(asv_counts[neg_controls$sample, ]) > 0))
clean_asv_counts[grep(id, rownames(clean_asv_counts)), contaminants] <- 0
all_contaminants[[id]] <- contaminants
}
ume_hb_samples = sample_metadata %>% filter(origin != "NC")
asv_taxa <- taxa[-which(taxa == "Chloroplast" | taxa == "Cellulosimicrobium" | taxa == "Mitochondria", arr.ind = TRUE)[,1],]
asv_taxa <- asv_taxa[which(asv_taxa[,"Kingdom"] == "Bacteria"),]
dim(taxa)[1] - dim(asv_taxa)[1]
clean_asv_counts <- clean_asv_counts[, rownames(asv_taxa)]
asv_sequences <- asv_seqs[rownames(asv_taxa)]
TAX <- tax_table(asv_taxa)
OTU <- otu_table(clean_asv_counts, taxa_are_rows = FALSE)
SAM <- sample_data(ume_hb_samples %>% column_to_rownames(var = "sample"))
SEQ <- refseq(asv_sequences)
ps1 <- merge_phyloseq(TAX, OTU, SAM, SEQ)
prevalenceThreshold <- 0.01 * min(count(sample_data(ps1), origin)$n)
taxa_prev <- apply(otu_table(ps1), 2, FUN = function(x) {sum(x > 0)})
ps2 <- prune_taxa(names(which(taxa_prev >= prevalenceThreshold)), ps1)
ps3 <- prune_samples(sample_sums(ps2) != 0, ps2)
ps3
alignment <- AlignSeqs(DNAStringSet(refseq(ps3)), anchor = NA, verbose = TRUE)
phangAlign <- phyDat(as(alignment, "matrix"), type = "DNA")
dm <- dist.ml(phangAlign)
treeNJ <- NJ(dm)
fit <- pml(treeNJ, data = phangAlign)
fitGTR <- update(fit, k = 4, inv = 0.2)
# fitGTR <- optim.pml(fitGTR, model = "GTR", optInv = TRUE, optGamma = TRUE, rearrangement = "stochastic", control = pml.control(trace = 0))
fitGTR <- readRDS("ume_hb_fitGTR.rds")
cmn_ps <- merge_phyloseq(phy_tree(fitGTR$tree), ps3)
cmn_ps
library(tidyverse)
library(maps)
library(ggmap)
library(raster)
library(ggsn)
library(cowplot)
knitr::opts_chunk$set(echo = TRUE)
ume_coords <- read_csv("ume_coords.csv")
season_colors2 = c("summer" = "white", "winter" = "black", "both" = "gray80")
site_colors2 = c("Oshine 1" = "black", "Nishi-honjo" = "black", "Ichiigawa" = "black",
"Kiyokawa 1" = "black", "Kamihaya" = "black",
"Kiyokawa 2" = "black", "Hirono" = "black", "Nagano" = "black",
"Oshine 2" = "black", "Yamauchi" = "black",
"Shimanose" = "black", "Higashi-honjo" = "red")
height <- max(ume_coords$latitude) - min(ume_coords$latitude)
width <- max(ume_coords$longitude) - min(ume_coords$longitude)
sites_area = c(bottom = min(ume_coords$latitude)  - 0.85 * height,
top    = max(ume_coords$latitude)  + 0.15 * height,
left   = min(ume_coords$longitude) - 0.75 * width,
right  = max(ume_coords$longitude) + 0.1 * width)
japan_map = map_data("world", region = "japan") %>%
ggplot(aes(x = long, y = lat, group = group)) +
geom_polygon(color = "black", fill = NA) +
xlim(129,146) + ylim(31, 48) +
annotate("rect", xmin = sites_area[[3]], xmax = sites_area[[4]],
ymin = sites_area[[1]], ymax = sites_area[[2]],
alpha = 0, color = "red", lwd = 0.6) +
theme(panel.background = element_rect(fill = "transparent"),
plot.background = element_rect(fill = "transparent", color = NA),
panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())
sites_map = get_stadiamap(sites_area, zoom = 13, maptype = "stamen_terrain_background") %>% ggmap() +
geom_point(data = ume_coords,
aes(x = longitude, y = latitude, fill = factor(season, levels = c("summer", "winter", "both")), color = location),
shape = 21, size = 4) +
scale_fill_manual(labels = c("summer", "winter", "both seasons"), values = season_colors2) +
scale_color_manual(values = site_colors2) +
scalebar(x.min = 135.298, x.max = 135.418, y.min = 33.7, y.max = 33.8,
transform = T, location = "bottomright", dist_unit = "km",
dist = 5, st.dist = 0.05, st.size = 4) +
theme(legend.position = c(0.2,0.82), axis.title = element_blank(), legend.text = element_text(size = 14),
axis.text = element_blank(), axis.ticks = element_blank(),
legend.background = element_rect(fill = "transparent"),
legend.key = element_rect(fill = "transparent"), legend.title = element_blank()) +
guides(color = FALSE)
full_map = ggdraw(sites_map) +
draw_plot(japan_map, x = 0.11, y = 0, width = 0.3, height = 0.5)
north2(full_map, x = 0.63, y = 0.18, scale = 0.1, symbol = 1)
library(eulerr)
library(VennDiagram)
library(MicrobiotaProcess)
library(ggnewscale)
library(venn)
library(grid)
library(gridExtra)
library(speedyseq)
library(DECIPHER)
source("helper_functions.R")
source("decipher_idclusters.R")
knitr::opts_chunk$set(echo = TRUE)
origin_colors = c("mouth" = "#bc4b51", "crop" = "#f4a259", "nectar" = "#648FFF")
# Set the number of cpus for clustering
set.seed(1279466746)
nproc <- 6
dna <- refseq(cmn_ps)
aln <- AlignSeqs(dna, processors = nproc)
d <- DistanceMatrix(aln, processors = nproc)
clusters <- IdClusters(d, method = "complete", cutoff = 0.03, processors = nproc)
cmn_OTU <- merge_taxa_vec(cmn_ps, group = clusters$cluster)
cmnOTU <- taxa_wrangle(cmn_OTU)
cmn_OTU
cmn_ps
cmnOTU
cmnOTU@sam_data$origin <- factor(cmnOTU@sam_data$origin, levels = c("mouth", "crop", "nectar"))
winTVL <- get_vennlist(obj = subset_samples(cmnOTU, season == "winter"), "origin")
winVD = venn.diagram(winTVL, height = 5, width = 5, filename = NULL, fill = origin_colors[c(1,2,3)], cat.col = c(NA, NA, NA),
alpha = 0.75, fontfamily = "serif", fontface = "bold", cex = 1.2, cat.cex = 1.3, cat.default.pos = "text",
col = "black", cat.dist = 0.1, margin = 0.1, lwd = 2, lty = "solid", euler.d = F, scaled = F,
inverted = T)
grid.draw(winVD)
grid.draw(winVD)
ceranaTVL <- get_vennlist(obj = subset_samples(cmnOTU, bee_species == "cerana" & season == "winter"), "origin")
ceranaVD = venn.diagram(ceranaTVL, height = 5, width = 5, filename = NULL, fill = origin_colors[c(1,2,3)], cat.col = c(NA, NA, NA),
alpha = 0.75, fontfamily = "serif", fontface = "bold", cex = 1.2, cat.cex = 1.3, cat.default.pos = "text",
col = "black", cat.dist = 0.1, margin = 0.1, lwd = 2, lty = "solid", euler.d = F, scaled = F,
inverted = T)
melliferaTVL <- get_vennlist(obj = subset_samples(cmnOTU, bee_species == "mellifera" & season == "winter"), "origin")
melliferaVD = venn.diagram(melliferaTVL, height = 5, width = 5, filename = NULL, fill = origin_colors[c(1,2,3)], cat.col = c(NA, NA, NA),
alpha = 0.75, fontfamily = "serif", fontface = "bold", cex = 1.2, cat.cex = 1.3, cat.default.pos = "text",
col = "black", cat.dist = 0.1, margin = 0.1, lwd = 2, lty = "solid", euler.d = F, scaled = F,
inverted = T)
grid.arrange(ceranaVD, melliferaVD, nrow = 1)
grid.arrange(ceranaVD, melliferaVD, nrow = 1)
grid.draw(winVD)
grid.draw(winVD)
grid.arrange(ceranaVD, melliferaVD, nrow = 1)
# Set the number of cpus for clustering
set.seed(1279466746)
nproc <- 6
dna <- refseq(cmn_ps)
aln <- AlignSeqs(dna, processors = nproc)
d <- DistanceMatrix(aln, processors = nproc)
clusters <- IdClusters(d, method = "complete", cutoff = 0.03, processors = nproc)
cmn_OTU <- merge_taxa_vec(cmn_ps, group = clusters$cluster)
cmnOTU <- taxa_wrangle(cmn_OTU)
cmnOTU
cmnOTU@sam_data$origin <- factor(cmnOTU@sam_data$origin, levels = c("mouth", "crop", "nectar"))
winTVL <- get_vennlist(obj = subset_samples(cmnOTU, season == "winter"), "origin")
winVD = venn.diagram(winTVL, height = 5, width = 5, filename = NULL, fill = origin_colors[c(1,2,3)], cat.col = c(NA, NA, NA),
alpha = 0.75, fontfamily = "serif", fontface = "bold", cex = 1.2, cat.cex = 1.3, cat.default.pos = "text",
col = "black", cat.dist = 0.1, margin = 0.1, lwd = 2, lty = "solid", euler.d = F, scaled = F,
inverted = T)
grid.draw(winVD)
grid.draw(winVD)
ceranaTVL <- get_vennlist(obj = subset_samples(cmnOTU, bee_species == "cerana" & season == "winter"), "origin")
ceranaVD = venn.diagram(ceranaTVL, height = 5, width = 5, filename = NULL, fill = origin_colors[c(1,2,3)], cat.col = c(NA, NA, NA),
alpha = 0.75, fontfamily = "serif", fontface = "bold", cex = 1.2, cat.cex = 1.3, cat.default.pos = "text",
col = "black", cat.dist = 0.1, margin = 0.1, lwd = 2, lty = "solid", euler.d = F, scaled = F,
inverted = T)
melliferaTVL <- get_vennlist(obj = subset_samples(cmnOTU, bee_species == "mellifera" & season == "winter"), "origin")
melliferaVD = venn.diagram(melliferaTVL, height = 5, width = 5, filename = NULL, fill = origin_colors[c(1,2,3)], cat.col = c(NA, NA, NA),
alpha = 0.75, fontfamily = "serif", fontface = "bold", cex = 1.2, cat.cex = 1.3, cat.default.pos = "text",
col = "black", cat.dist = 0.1, margin = 0.1, lwd = 2, lty = "solid", euler.d = F, scaled = F,
inverted = T)
grid.arrange(ceranaVD, melliferaVD, nrow = 1)
grid.arrange(ceranaVD, melliferaVD, nrow = 1)
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform = FALSE)
library(phyloseq)
library(tidyverse)
library(vegan)
library(lme4)
library(microbiome)
detach("package:MicrobiotaProcess", unload = T)
source("helper_functions.R")
alpha_measures = c("Shannon", "Observed")
cmn_alpha <- data.frame(cmnOTU@sam_data, estimate_richness(cmnOTU, measures = alpha_measures)) %>%
mutate(site2 = ifelse(site == "Nishi-honjo", ifelse(season == "winter", "Nishi-Honjo_W", "Nishi-Honjo_S"), site),
site_alpha = factor(site2, levels = c("Ichiigawa", "Kiyokawa 1", "Oshine 1", "Nishi-Honjo_S","Nishi-Honjo_W", "Higashi-honjo", "Hirono", "Kamihaya", "Kiyokawa 2", "Nagano", "Oshine 2", "Shimanose", "Yamauchi")),
origin = factor(origin, levels = c("crop", "mouth", "nectar")))
cmn_alpha = merge(cmn_alpha, microbiome::evenness(cmnOTU, index = "pielou"), by = 0) %>%
mutate(pielou = ifelse(is.nan(pielou), 0, pielou)) %>%
column_to_rownames(var = "Row.names")
# Filter for winter season and compare crop to mouth, mouth to nectar, and nectar to crop. Filter for summer season and compare crop to mouth
alpha_stats <- lapply(c("summer", "winter"), function(s) {
df <- cmn_alpha %>% filter(season == s)
combos <- combn(unique(df$origin), 2)
stats <- lapply(seq_len(ncol(combos)),function(c) {
Shannon_stat <- t.test(df[df$origin == combos[,c][2], "Shannon"],
df[df$origin == combos[,c][1], "Shannon"], alternative = "two.sided")
even_stat <- t.test(df[df$origin == combos[,c][2], "pielou"],
df[df$origin == combos[,c][1], "pielou"], alternative = "two.sided")
return(list("shannon" = Shannon_stat, "evenness" = even_stat))
})
names(stats) <- paste(combos[2,], combos[1,], sep = "_")
df <- df %>% group_by(origin) %>% summarize(shannon_mean = mean(Shannon), evenness_mean = mean(pielou))
return(list("stats" = stats, "means" = df))
})
names(alpha_stats) <- c("summer", "winter")
alpha_stats
origin_colors = c("crop" = "#f4a259", "mouth" = "#bc4b51", "nectar" = "#648FFF")
origin_shapes = c("crop" = 25, "mouth" = 23, "nectar" = 22)
bee_shapes = c("cerana" = 16, "mellifera" = 17)
bootfun <- function(x) c(as.numeric(ranef(x)[["site_alpha"]][,1]), fixef(x)[["(Intercept)"]])
sample_type = c("crop", "mouth", "nectar")
season = c("winter", "summer")
ss_comb = crossing(sample_type, season) %>%
rowwise() %>%
mutate(comm = list(c(sample_type, season)))
ss_comb <- append(ss_comb$comm[c(1:4,6)], sample_type, after = 0)
pseudo_nec = data.frame(site = c("Ichiigawa", "Kiyokawa 1", "Oshine 1", "Nishi-Honjo_S"), season = rep("summer", 4),
mean = rep(NA, 4), med = rep(NA, 4), lo = rep(NA, 4), hi = rep(NA, 4))
pseudo_summer_nectar = data.frame(origin = rep("nectar", 4), sample_name = rep(NA, 4), date = rep(NA, 4),
season = rep("summer", 4), year = rep(NA, 4), bee_genera = rep(NA, 4),
bee_species = rep(NA, 4), pollen_basket = rep(NA, 4),
location = c("Ichiigawa", "Kiyokawa 1", "Oshine 1", "Nishi-Honjo_S"),
Lk_like_CFU_crop = rep(NA, 4), Pa_like_CFU_crop = rep(NA, 4), elevation = rep(NA, 4),
longitude = rep(NA, 4), latitude = rep(NA, 4),
site = c("Ichiigawa", "Kiyokawa 1", "Oshine 1", "Nishi-Honjo_S"),
Observed = rep(NA, 4), Shannon = rep(NA, 4),
site2 = c("Ichiigawa", "Kiyokawa 1", "Oshine 1", "Nishi-Honjo_S"),
site_alpha = c("Ichiigawa", "Kiyokawa 1", "Oshine 1", "Nishi-Honjo_S"),
pielou = rep(NA, 4))
set.seed(1279466746)
alpha_sim = lapply(ss_comb, function(tissue) {
alpha_df <- alpha_wrangle(cmn_alpha, tissue)
results = lapply(alpha_measures, function(m) {
alpha_res <- boot_res(alpha_measure = m, bootfun = bootfun, df = alpha_df)
ref_df <- random_effect_df(alpha_res$results)
rich_df <- alpha_results_df(alpha_res$results)
if (unique(alpha_df$origin) == "nectar") {
ref_df <- rbind(ref_df, pseudo_nec)
rich_df <- rbind(rich_df, pseudo_nec)
alpha_df <- rbind(alpha_df, pseudo_summer_nectar)
}
ref_plot <- random_effect_plot(ref_df, tissue)
alpha_plot <- alpha_results_plot(rich_df, alpha_df, tissue, m)
return(list("lm" = alpha_res$alpha_mod, "sim" = alpha_res$results, "ranef_plot" = ref_plot, "alpha_plot" = alpha_plot))
})
names(results) = alpha_measures
return(results)
})
names(alpha_sim) = c("crop", "mouth", "nectar", "summer_crop", "winter_crop", "summer_mouth",
"winter_mouth", "winter_nectar")
# Save 8 x 4 inches
grid.arrange(alpha_sim$crop$Shannon$alpha_plot + ylim(-0.2, 4) + theme_classic() +
theme(axis.title = element_blank(), axis.text.x = element_blank(),
axis.ticks.x = element_blank(), legend.position = "none"),
alpha_sim$mouth$Shannon$alpha_plot + ylim(-0.2, 4) + theme_classic() +
theme(axis.title = element_blank(), axis.ticks.x = element_blank(),
axis.text.x = element_blank(), legend.position = "none"),
alpha_sim$nectar$Shannon$alpha_plot + ylim(-0.2, 4) + theme_classic() +
theme(axis.title = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"),
textGrob("Shannon", rot = 90, gp = gpar(col = "black", fontsize = 16)),
layout_matrix = rbind(c(NA, 1), c(4, 2), c(NA, 3)),
heights = c(0.3, 0.3, 0.4),
widths = c(0.04, 0.96))
grid.arrange(alpha_sim$crop$Shannon$ranef_plot + xlim(-1.5, 2.5) + theme_classic() +
theme(axis.title.x = element_blank()),
alpha_sim$mouth$Shannon$ranef_plot + xlim(-1.5, 2.5) + theme_classic() +
theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
axis.title.y = element_blank()),
alpha_sim$nectar$Shannon$ranef_plot + xlim(-1.5, 2.5) + theme_classic() +
theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),
axis.title = element_blank()),
layout_matrix = rbind(c(1, 2, 3), c(1, 2, 3), c(NA, 2, NA)),
heights = c(0.255, 0.65, 0.05),
widths = c(0.4, 0.3, 0.3))
library(phyloseq)
library(vegan)
library(ellipse)
library(tidyverse)
library(gghighlight)
library(gridExtra)
source("helper_functions.R")
knitr::opts_chunk$set(echo = TRUE)
origin_colors = c("mouth" = "#bc4b51", "crop" = "#f4a259", "nectar" = "#648FFF")
bee_shapes = c("cerana" = 16, "mellifera" = 17)
cmn_prop <- transform_sample_counts(cmnOTU, function(x) {x/sum(x)})
cmn <- subset_pcoa(cmn_prop, d = "wunifrac")
cmn_ps_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter"), c("nectar", "winter")),
function(x) {
return(plot_PCoA_w_highlight(cmn$physeq, paste(x, collapse = "_"), cmn$values, colorcode = "origin", shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors, line_scheme = c("cerana" = "dashed", "mellifera" = "solid"), shape_scheme = bee_shapes, catg1 = "origin", grp1 = x[[1]], catg2 = "season", grp2 = x[[2]], op = "and"))
})
names(cmn_ps_pcoas) = unlist(lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter"), c("nectar", "winter")), paste, collapse = "_"))
basic_theme <- theme(axis.title = element_blank(), title = element_blank(), legend.position = "none")
minimal_theme <- theme(axis.ticks = element_blank(), axis.text = element_blank())
grid.arrange(cmn_ps_pcoas$crop_summer[[1]]$pcoa_w_ell + basic_theme +
theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()),
cmn_ps_pcoas$crop_winter[[1]]$pcoa_w_ell + basic_theme + minimal_theme,
cmn_ps_pcoas$mouth_summer[[1]]$pcoa_w_ell + basic_theme,
cmn_ps_pcoas$mouth_winter[[1]]$pcoa_w_ell + basic_theme + minimal_theme,
cmn_ps_pcoas$nectar_winter[[1]]$pcoa_w_ell + basic_theme,
textGrob(paste0("Axis 1 (", round(cmn$values$Relative_eig[1] * 100, 1), "%)"),
gp = gpar(col = "black", fontsize = 16)),
textGrob(paste0("Axis 2 (", round(cmn$values$Relative_eig[2] * 100, 1), "%)"),
gp = gpar(col = "black", fontsize = 16), rot = 90),
layout_matrix = rbind(c(NA, NA, NA, NA, NA, NA), c(NA, 1, 1, 2, 2, NA), c(7, 3, 3, 4, 4, NA),
c(7, 3, 3, 4, 4, NA), c(NA, 3, 5, 5, 5, NA), c(NA, NA, 5, 5, 5, NA),
c(NA, 6, 6, 6, 6, NA)),
widths = c(0.03, 0.44, 0.04, 0.02, 0.42, 0.05), heights = c(0.05, 0.30, 0.28, 0.02, 0.02, 0.29, 0.04))
knitr::opts_chunk$set(echo = TRUE)
season_fills = c("summer" = "white", "winter" = "black")
origin_colors = c("crop" = "#f4a259", "mouth" = "#bc4b51")
metadata <- read_csv("ume_hb_sample_metadata.csv")
qpcr_data <- read_csv("qpcr_analysis_input_data.csv")
qd <- left_join(qpcr_data, metadata, by = join_by("samples" == "sample")) %>%
mutate(quantification = as.numeric(quantification),
season = factor(season, levels = c("summer", "winter")),
origin = factor(origin, levels = c("crop", "mouth")))
ggplot(qd, aes(x = season, y = quantification)) +
stat_summary(fun = mean, geom = "crossbar", width = 0.9, alpha = 0.8) +
geom_beeswarm(aes(fill = season), color = "black", cex = 2.5, shape = 21, alpha = 0.8) +
scale_fill_manual(values = season_fills) +
facet_wrap(~ origin) +
scale_y_log10(limits = c(1, 10000000),  labels = scales::trans_format("log10", scales::math_format(10^.x))) +
geom_signif(comparisons = list(c("summer", "winter")),
map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1),
y_position = c(6.25,6.25)) +
ylab("Total 16S rRNA gene copies") + theme_classic() +
theme(legend.position = "none", axis.title.x = element_blank(),
strip.background = element_blank(), strip.text = element_text(size = 12))
library(tidyverse)
library(ggsignif)
library(ggtext)
library(ggbeeswarm)
library(gghighlight)
library(ellipse)
source("helper_functions.R")
ggplot(qd, aes(x = season, y = quantification)) +
stat_summary(fun = mean, geom = "crossbar", width = 0.9, alpha = 0.8) +
geom_beeswarm(aes(fill = season), color = "black", cex = 2.5, shape = 21, alpha = 0.8) +
scale_fill_manual(values = season_fills) +
facet_wrap(~ origin) +
scale_y_log10(limits = c(1, 10000000),  labels = scales::trans_format("log10", scales::math_format(10^.x))) +
geom_signif(comparisons = list(c("summer", "winter")),
map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1),
y_position = c(6.25,6.25)) +
ylab("Total 16S rRNA gene copies") + theme_classic() +
theme(legend.position = "none", axis.title.x = element_blank(),
strip.background = element_blank(), strip.text = element_text(size = 12))
cm_abs <- prune_samples(qd$samples, cmn_prop)
sample_data(cm_abs) <- sample_data(left_join(data.frame(cm_abs@sam_data) %>%
rownames_to_column(var = "name"),
qd %>% dplyr::select(samples, quantification), by = join_by("name" == "samples")) %>%
column_to_rownames(var = "name"))
# Transform relative abundance counts to absolute abundance by multiplying proportion by the number of 16S rRNA gene copies in each sample.
otu_table(cm_abs) <- cm_abs@otu_table * cm_abs@sam_data$quantification
cm_abs = subset_pcoa(cm_abs, d = "wunifrac")
abs_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")),
function(x) {
return(plot_PCoA_w_highlight(cm_abs$physeq, paste(x, collapse = "_"), cm_abs$values, colorcode = "origin",
shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors,
line_scheme = c("cerana" = "dotted", "mellifera" = "solid"), shape_scheme = bee_shapes,
catg1 = "origin", grp1 = x[[1]], catg2 = "season", grp2 = x[[2]], op = "and"))
})
cm_abs
cm_abs$physeq
abs_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")),
function(x) {
return(plot_PCoA_w_highlight(cm_abs$physeq, paste(x, collapse = "_"), cm_abs$values, colorcode = "origin",
shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors,
line_scheme = c("cerana" = "dotted", "mellifera" = "solid"), shape_scheme = bee_shapes,
catg1 = "origin", grp1 = x[[1]], catg2 = "season", grp2 = x[[2]], op = "and"))
})
data.frame(cm_abs$physeq@sam_data) %>% dplyr::count(season, origin)
data.frame(cm_abs$physeq@sam_data) %>% dplyr::count(season, origin, bee_species)
abs_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")[1]),
function(x) {
return(plot_PCoA_w_highlight(cm_abs$physeq, paste(x, collapse = "_"), cm_abs$values, colorcode = "origin",
shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors,
line_scheme = c("cerana" = "dotted", "mellifera" = "solid"), shape_scheme = bee_shapes,
catg1 = "origin", grp1 = x[[1]], catg2 = "season", grp2 = x[[2]], op = "and"))
})
lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")[1], print)
)
lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter"))[1], print)
abs_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter"))[1]),
abs_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter"))[1],
function(x) {
return(plot_PCoA_w_highlight(cm_abs$physeq, paste(x, collapse = "_"), cm_abs$values, colorcode = "origin",
shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors,
line_scheme = c("cerana" = "dotted", "mellifera" = "solid"), shape_scheme = bee_shapes,
catg1 = "origin", grp1 = x[[1]], catg2 = "season", grp2 = x[[2]], op = "and"))
})
plot_PCoA_w_highlight(cm_abs$physeq, paste(c("crop", "summer"), collapse = "_"), cm_abs$values, colorcode = "origin",
shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors,
line_scheme = c("cerana" = "dotted", "mellifera" = "solid"), shape_scheme = bee_shapes,
catg1 = "origin", grp1 = "crop", catg2 = "season", grp2 = "summer", op = "and")
prune_samples(row.names(data.frame(sample_data(cm_abs$physeq)) %>% dplyr::filter(.data[["origin"]] == "crop" & .data[["season"]] == "summer")))
prune_samples(row.names(data.frame(sample_data(cm_abs$physeq)) %>% dplyr::filter(.data[["origin"]] == "crop" & .data[["season"]] == "summer")), cm_abs$physeq)
draw_ellipses("bee_species", param2 = "origin", np2 = "crop", physeq = prune_samples(row.names(data.frame(sample_data(cm_abs$physeq)) %>% dplyr::filter(.data[["origin"]] == "crop" & .data[["season"]] == "summer")), cm_abs$physeq), axis1 = "Axis.1", axis2 = "Axis.2")
plot_PCoA_w_highlight <- function(phyobj, phyname, values, colorcode, shapecode, linecode,
color_scheme = bee_colors, line_scheme = NULL, shape_scheme = NULL,
catg1, grp1, catg2 = NULL, grp2 = NULL, catg3 = NULL, grp3 = NULL, op = NULL) {
DATA = data.frame(sample_data(phyobj))
full_name = phyname
if (is.null(catg2) & is.null(catg3)) {
ellipse_ps = prune_samples(row.names(DATA %>% dplyr::filter(.data[[catg1]] == grp1)), phyobj)
} else if (op == "and") {
ellipse_ps = prune_samples(row.names(DATA %>% dplyr::filter(.data[[catg1]] == grp1 & .data[[catg2]] == grp2)), phyobj)
} else if (op == "or") {
ellipse_ps = prune_samples(row.names(DATA %>% dplyr::filter(.data[[catg1]] == grp1 | .data[[catg2]] == grp2)), phyobj)
}
if(!is.null(catg3)) {
ellipse_ps = prune_samples(sample_data(phyobj)$catg3 == grp3, ellipse_ps)
}
lapply(list(c(1, 2), c(2, 3), c(1, 3)), function(x) {
xaxis = x[1]
yaxis = x[2]
x_name = paste0("Axis.", xaxis)
y_name = paste0("Axis.", yaxis)
ellipse_df = draw_ellipses(shapecode, param2 = grp1, np2 = catg1, physeq = ellipse_ps, axis1 = x_name, axis2 = y_name)
if ("nectar" %in% unique(DATA$origin)) {
others = rbind(crossing(c("crop", "mouth"), unique(DATA[,catg2])), c("nectar", "winter"))
} else {
others = rbind(crossing(c("crop", "mouth"), unique(DATA[,catg2])))
}
f_df = do.call(rbind, apply(others, MARGIN = 1, function(y) {
ps = prune_samples(DATA[,catg1] == y[[1]] & DATA[,catg2] == y[[2]], phyobj)
df = draw_ellipses(shapecode, physeq = ps, axis1 = x_name, axis2 = y_name)
return(df)
}))
total_lims = lapply(2:3, function(x) {
d_col = ifelse(x == 2, x_name, y_name)
c = c(DATA[,d_col], ellipse_df[,x], f_df[,x])
return(list(lo = min(c), hi = max(c)))
})
names(total_lims) = c("x", "y")
axis1_exp <- round(values$Relative_eig[xaxis] * 100, 1)
axis2_exp <- round(values$Relative_eig[yaxis] * 100, 1)
pcoa_plot = ggplot(DATA, aes(x = .data[[x_name]], y = .data[[y_name]])) +
suppressWarnings(geom_point(aes(color = .data[[colorcode]], shape = .data[[shapecode]], text = sample_name), alpha = 0.7, size = 2)) +
geom_vline(xintercept = 0, color = "darkgrey", linetype = "dashed") +
geom_hline(yintercept = 0, color = "darkgrey", linetype = "dashed") +
xlim(total_lims$x$lo, total_lims$x$hi) +
ylim(total_lims$y$lo, total_lims$y$hi) +
scale_color_manual("Sample type", values = color_scheme) +
labs(color = colorcode, shape = shapecode, line = shapecode) +
theme_classic() +
theme(legend.title = element_blank()) +
if (is.null(catg2) & is.null(catg3)) {
gghighlight(.data[[catg1]] == grp1, use_group_by = FALSE)
} else if (op == "and") {
if(is.null(catg3)) {
gghighlight(.data[[catg1]] == grp1 & .data[[catg2]] == grp2, use_group_by = FALSE)
} else {
gghighlight(.data[[catg1]] == grp1 & .data[[catg2]] == grp2 & .data[[catg3]] == grp3, use_group_by = FALSE)
}
} else if (op == "or") {
if(is.null(catg3)) {
gghighlight(.data[[catg1]] == grp1 | .data[[catg2]] == grp2, use_group_by = FALSE)
} else {
gghighlight(.data[[catg1]] == grp1 | .data[[catg2]] == grp2 | .data[[catg3]] == grp3, use_group_by = FALSE)
}
}
pcoa_w_axis_lab = pcoa_plot + xlab(paste0("Axis ", xaxis, " (", axis1_exp, "%)")) +
ylab(paste0("Axis ", yaxis, " (", axis2_exp, "%)")) +
ggtitle(ifelse(!is.null(grp2), paste(grp2, grp1, "PCoA"), paste(grp1, "PCoA"))) +
theme(axis.text = element_text(size = 12), axis.title = element_text(size = 14))
pcoa_w_ell = pcoa_w_axis_lab + geom_path(data = ellipse_df, aes(color = .data[[colorcode]], linetype = .data[[linecode]])) +
scale_linetype_manual("", values = line_scheme) + theme(plot.title = element_blank())
pcoas = list("pcoa" = pcoa_w_axis_lab, "pcoa_w_ell" = pcoa_w_ell)
return(pcoas)
})
}
abs_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter"))[1],
function(x) {
return(plot_PCoA_w_highlight(cm_abs$physeq, paste(x, collapse = "_"), cm_abs$values, colorcode = "origin",
shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors,
line_scheme = c("cerana" = "dotted", "mellifera" = "solid"), shape_scheme = bee_shapes,
catg1 = "origin", grp1 = x[[1]], catg2 = "season", grp2 = x[[2]], op = "and"))
})
names(abs_pcoas) = unlist(lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")), paste, collapse = "_"))
abs_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")),
function(x) {
return(plot_PCoA_w_highlight(cm_abs$physeq, paste(x, collapse = "_"), cm_abs$values, colorcode = "origin",
shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors,
line_scheme = c("cerana" = "dotted", "mellifera" = "solid"), shape_scheme = bee_shapes,
catg1 = "origin", grp1 = x[[1]], catg2 = "season", grp2 = x[[2]], op = "and"))
})
names(abs_pcoas) = unlist(lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")), paste, collapse = "_"))
grid.arrange(abs_pcoas$crop_summer[[1]]$pcoa_w_ell + basic_theme + theme(plot.margin = unit(c(5.5, 6.5, 5.5, 5.5), units = "points")),
abs_pcoas$crop_winter[[1]]$pcoa_w_ell + basic_theme + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()),
abs_pcoas$mouth_summer[[1]]$pcoa_w_ell + basic_theme + theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()),
abs_pcoas$mouth_winter[[1]]$pcoa_w_ell + basic_theme + minimal_theme,
textGrob(paste0("Axis 1 (", round(cm_abs$values$Relative_eig[1] * 100, 1), "%)"), gp = gpar(col = "black", fontsize = 16)),
textGrob(paste0("Axis 2 (", round(cm_abs$values$Relative_eig[2] * 100, 1), "%)"), gp = gpar(col = "black", fontsize = 16), rot = 90),
layout_matrix = rbind(c(NA, NA, NA, NA), c(6, 2, 4, NA), c(6, 1, 3, NA), c(NA, 5, 5, NA)),
widths = c(0.03, 0.47, 0.45, 0.05), heights = c(0.05, 0.45, 0.46, 0.04))
library(phyloseq)
library(rbiom)
library(tidyverse)
library(vegan)
library(DESeq2)
library(dada2)
library(phangorn)
library(ggtree)
library(viridis)
library(pheatmap)
library(gtable)
library(ggpubr)
library(DECIPHER)
library(Biostrings)
library(gridExtra)
library(grid)
detach("package:microbiome", unload = T)
source("helper_functions.R")
knitr::opts_chunk$set(echo = TRUE)
orig_comps <- list(c("crop", "winter"), c("mouth", "winter"), c("nectar", "winter"), c("nectar", "summer"))
orig_deseqs <- lapply(orig_comps, function(v) {
ps <- prune_samples(cmnOTU@sam_data$origin != v[1] & cmnOTU@sam_data$season == v[2], cmnOTU)
ps <- prune_taxa(taxa_sums(ps) != 0, ps)
results <- dif_abund_deseq(ps, variable = "origin", alpha = 0.05, physeq_name = paste0(v[1], " excluded in ", v[2]))
return(results)
})
names(orig_deseqs) <- unlist(lapply(orig_comps, function(x) paste("no", paste0(x, collapse = "_"), sep = "_")))
