---
title: "Figure 5"
author: "MW"
date: "2024-02-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(tidyverse)
library(ggsignif)
library(ggtext)
library(ggbeeswarm)
library(gghighlight)
library(ellipse)
library(gridExtra)
library(grid)
library(pheatmap)
library(ComplexHeatmap)
source("helper_functions.R")
```

Set colors. 
```{r aesthetics}
season_fills = c("summer" = "white", "winter" = "black")
origin_colors = c("crop" = "#f4a259", "mouth" = "#bc4b51")
bee_colors = c("cerana" = "#8cb369", "mellifera" = "#f4e285")
```

Load in the data. 
```{r data_load}
sample_metadata <- read_csv("Supplementary_data_1.csv")

qpcr_data <- read_csv("Supplementary_data_3.csv") 

qd <- left_join(qpcr_data, sample_metadata, by = join_by("samples" == "sample")) %>% 
  mutate(quantification = as.numeric(quantification), 
         season = factor(season, levels = c("summer", "winter")), 
         origin = factor(origin, levels = c("crop", "mouth")))
```

For Figure 5A, we used the product of each sample's qPCR quantification and the relative proportion of each taxa in the sample to calculate the absolute abundance of each taxa in each sample. We used this calculation to examine a PCoA based on the absolute bacterial abundance of each sample. 
```{r abs_pcoa, message=FALSE}
cm_abs <- prune_samples(qd$samples, cmn_prop)
sample_data(cm_abs) <- sample_data(left_join(data.frame(cm_abs@sam_data) %>% 
                                           rownames_to_column(var = "name"), 
                                           qd %>% dplyr::select(samples, quantification), by = join_by("name" == "samples")) %>% 
                                     column_to_rownames(var = "name"))

# Transform relative abundance counts to absolute abundance by multiplying proportion by the number of 16S rRNA gene copies in each sample. 
otu_table(cm_abs) <- cm_abs@otu_table * cm_abs@sam_data$quantification

cm_abs = subset_pcoa(cm_abs, d = "wunifrac")

abs_pcoas = lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")), 
         function(x) {
           return(plot_PCoA_w_highlight(cm_abs$physeq, paste(x, collapse = "_"), cm_abs$values, colorcode = "origin", 
                                        shapecode = "bee_species", linecode = "bee_species", color_scheme = origin_colors, 
                                        line_scheme = c("cerana" = "dotted", "mellifera" = "solid"), shape_scheme = bee_shapes, 
                                        catg1 = "origin", grp1 = x[[1]], catg2 = "season", grp2 = x[[2]], op = "and"))
         })
  
names(abs_pcoas) = unlist(lapply(list(c("crop", "summer"), c("crop", "winter"), c("mouth", "summer"), c("mouth", "winter")), paste, collapse = "_"))

basic_theme <- theme(axis.title = element_blank(), title = element_blank(), legend.position = "none")
minimal_theme <- theme(axis.ticks = element_blank(), axis.text = element_blank())

abs_pcoa_plot = grid.arrange(abs_pcoas$mouth_summer[[1]]$pcoa_w_ell + basic_theme + theme(plot.margin = unit(c(5.5, 6.5, 5.5, 5.5), units = "points")), 
             abs_pcoas$crop_summer[[1]]$pcoa_w_ell + basic_theme + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()), 
             abs_pcoas$mouth_winter[[1]]$pcoa_w_ell + basic_theme + theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()), 
             abs_pcoas$crop_winter[[1]]$pcoa_w_ell + basic_theme + minimal_theme, 
             textGrob(paste0("Axis 1 (", round(cm_abs$values$Relative_eig[1] * 100, 1), "%)"), gp = gpar(col = "black", fontsize = 16)),
             textGrob(paste0("Axis 2 (", round(cm_abs$values$Relative_eig[2] * 100, 1), "%)"), gp = gpar(col = "black", fontsize = 16), rot = 90),
             textGrob("Summer", gp = gpar(col = "black", fontsize = 14)), 
             textGrob("Winter", gp = gpar(col = "black", fontsize = 14), hjust = 1),
             textGrob("A", gp = gpar(col = "black", fontsize = 16)), 
             layout_matrix = rbind(c(9, 7, 8, NA), c(6, 2, 4, NA), c(6, 1, 3, NA), c(NA, 5, 5, NA)), 
             widths = c(0.03, 0.47, 0.45, 0.05), heights = c(0.05, 0.45, 0.46, 0.04))

samType_leg = Legend(at = c("crop", "mouth"), title = "Sample type", title_gp = gpar(fontsize = 12, fontface = "bold"), legend_gp = gpar(fill = origin_colors[c(1,2)]), grid_height = unit(3, "mm"), grid_width = unit(4, "mm"), labels_gp = gpar(fontsize = 10))
species_shape_legend = Legend(at = c("Apis cerana", "Apis mellifera"), title = "Bee species", title_gp = gpar(fontsize = 12, fontface = "bold"), labels_gp = gpar(fontface = "italic", fontsize = 10), graphics = list(function(x, y, w, h) grid.points(x, y, pch = 1, size = unit(3.5, "mm")), function(x, y, w, h) grid.points(x, y, pch = 2, size = unit(3.5, "mm"))))
```

Beta diversity statistics.
```{r betadiv_stats}
set.seed(1279466746)
adonis2(UniFrac(cm_abs$physeq, weighted = T) ~ origin + season + bee_species, data = data.frame(cm_abs$physeq@sam_data))

cm_abs_stats = lapply(list(c("crop", "season"), c("mouth", "season")), function(v) {
                              ps = cm_abs$physeq %>% filter_sample_data(origin == v[1])
                              return(betadiv_stats(ps, parameter = v[2]))
                              })
names(cm_abs_stats) = c("crop_season", "mouth_season")
```

Plot Figure 5B quantitative PCR results. 
```{r qpcr_plot}
# Change bee species labels
strip_labs = c("crop" = "crop", "mouth" = "mouth", "cerana" = "Apis cerana", "mellifera" = "Apis mellifera")

bac_load_plot = ggplot(qd, aes(x = season, y = quantification)) + 
  stat_summary(fun = mean, geom = "crossbar", width = 0.9, alpha = 0.8) +
  geom_beeswarm(aes(fill = season), color = "black", cex = 2.5, shape = 21, alpha = 0.8) +
  scale_fill_manual(values = season_fills) +
  facet_grid(bee_species ~ origin, labeller = as_labeller(strip_labs)) + 
  scale_y_log10(limits = c(1, 10000000),  labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  geom_signif(comparisons = list(c("summer", "winter")), 
              map_signif_level = c("***" = 0.001, "**" = 0.01, "*" = 0.05, "ns" = 1), 
              y_position = c(6.25,6.25)) +
  ylab("Total 16S rRNA gene copies") + theme_classic() +
  theme(legend.position = "none", axis.title.x = element_blank(), 
        axis.text = element_text(size = 12), axis.title.y = element_text(size = 14),
        strip.background = element_rect(fill = "transparent", color = "transparent"), 
        strip.text = element_text(size = 12, color = "black"), 
        strip.text.y = element_text(face = "italic"))

# Change the color of the bee species labels to match the other figures
g = ggplot_gtable(ggplot_build(bac_load_plot))
stripr = which(grepl("strip-r", g$layout$name))
for (i in stripr) {
  rect_grob = which(grepl("rect", g$grobs[[i]]$grobs[[1]]$childrenOrder))
  txt_grob = which(grepl("text", g$grobs[[i]]$grobs[[1]]$childrenOrder))
  bee_col = ifelse(g$grobs[[i]]$grobs[[1]]$children[[txt_grob]]$children[[1]]$label == "Apis cerana", bee_colors[["cerana"]], bee_colors[["mellifera"]])
  g$grobs[[i]]$grobs[[1]]$children[[rect_grob]]$gp$fill = bee_col
}
```

To create the jpeg figure
```{r fig5_jpg}
jpeg(filename = "Fig5.jpg", width = 375, height = 200, units = "mm", res = 400, pointsize = 16)
grid.arrange(abs_pcoa_plot, g, textGrob("B", gp = gpar(col = "black", fontsize = 16), vjust = 1), layout_matrix = rbind(c(1, 1, 1, 3, NA, NA), c(1, 1, 1, NA, 2, 2), c(1, 1, 1, NA, 2, 2), c(1, 1, 1, NA, 2, 2), c(1, 1, 1, NA, 2, 2), c(1, 1, 1, NA, 2, 2), c(1, 1, 1, NA, NA, NA), c(1, 1, 1, NA, NA, NA)), heights = c(0.01, 0.14, 0.14, 0.14, 0.14, 0.14, 0.14, 0.13), widths = c(0.2, 0.2, 0.2, 0.01, 0.19, 0.2))
draw(samType_leg, x = unit(0.3, "npc"), y = unit(0.6, "npc"), just = c("right", "top"))
draw(species_shape_legend, x = unit(0.3, "npc"), y = unit(0.5, "npc"), just = c("right", "top"))
grid.lines(x = unit(c(0.23, 0.245), "npc"), y = unit(0.464, "npc"), gp = gpar(lty = "dashed", lwd = 1))
grid.lines(x = unit(c(0.23, 0.242), "npc"), y = unit(0.447, "npc"), gp = gpar(lty = "solid", lwd = 1))
dev.off()
```